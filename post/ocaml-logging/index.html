<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https://anuragsoni.github.io" />
    <meta name="author" content="Anurag Soni" />
    <meta name="description" content="&lt;h2 id=&quot;why&quot;&gt;Why?&lt;&#x2F;h2&gt;
&lt;p&gt;Effectively running systems in production requires application level support for providing better visibility into what&#x27;s happening at runtime. Instrumenting applications to provide structured, context aware traces&#x2F;events is becoming easier thanks to efforts like &lt;a href=&quot;https:&#x2F;&#x2F;opentelemetry.io&#x2F;docs&#x2F;&quot;&gt;OpenTelemetry&lt;&#x2F;a&gt;, which is a vendor neutral framework for instrumentation and trace collection.">
    <meta property="og:title" content="Better logging for OCaml + Async">
    <meta property="og:url" content="https://anuragsoni.github.io/post/ocaml-logging">
    <meta property="og:description" content="&lt;h2 id=&quot;why&quot;&gt;Why?&lt;&#x2F;h2&gt;
&lt;p&gt;Effectively running systems in production requires application level support for providing better visibility into what&#x27;s happening at runtime. Instrumenting applications to provide structured, context aware traces&#x2F;events is becoming easier thanks to efforts like &lt;a href=&quot;https:&#x2F;&#x2F;opentelemetry.io&#x2F;docs&#x2F;&quot;&gt;OpenTelemetry&lt;&#x2F;a&gt;, which is a vendor neutral framework for instrumentation and trace collection.">
    <link rel="stylesheet" href="https://anuragsoni.github.io/style.css" />
    <link rel="me" href="https://discuss.systems/@soni" />
    <title>
    Better logging for OCaml + Async
</title>
</head>

<body>
    <nav class="menu">
        <header>Menu:</header>
        <ul>
            <li><a class="sans-serif" href="/">Home</a></li>
            <li><a class="sans-serif" href="/about">About</a></li>
            <li><a class="sans-serif" href="/tags">Tags</a></li>
        </ul>
    </nav>    
    <div class="container">
        
<h1 class="title">
    Better logging for OCaml + Async
</h1>
<p class="subtitle"><strong class="sans-serif">September  2, 2022</strong></p>

<ul>
    
    <li>
        <a class="sans-serif" href="https://anuragsoni.github.io/post/ocaml-logging/#why">Why?</a>
        
    </li>
    
    <li>
        <a class="sans-serif" href="https://anuragsoni.github.io/post/ocaml-logging/#problems-with-the-default-async-logger">Problems with the default Async logger</a>
        
    </li>
    
    <li>
        <a class="sans-serif" href="https://anuragsoni.github.io/post/ocaml-logging/#better-logging-configuration">Better Logging configuration</a>
        
        <ul>
            
            <li>
                <a class="sans-serif" href="https://anuragsoni.github.io/post/ocaml-logging/#json-formatted-logs">JSON formatted logs</a>
            </li>
            
            <li>
                <a class="sans-serif" href="https://anuragsoni.github.io/post/ocaml-logging/#unique-identifiers-for-transactions">Unique identifiers for transactions</a>
            </li>
            
        </ul>
        
    </li>
    
    <li>
        <a class="sans-serif" href="https://anuragsoni.github.io/post/ocaml-logging/#conclusion">Conclusion</a>
        
    </li>
    
</ul>

<h2 id="why">Why?</h2>
<p>Effectively running systems in production requires application level support for providing better visibility into what's happening at runtime. Instrumenting applications to provide structured, context aware traces/events is becoming easier thanks to efforts like <a href="https://opentelemetry.io/docs/">OpenTelemetry</a>, which is a vendor neutral framework for instrumentation and trace collection.</p>
<span id="continue-reading"></span>
<p>Using auto-instrumentation, either via OpenTelemetry SDKs for the language of your choice, or an observability vendor specific library has a lot of benefits. These libraries typically come with out-of-the-box support for instrumenting a wide set of libraries and propagating useful events to a collection agent (Elastic, Honeycomb, and more). Structured events also have the benefit of allowing the addition of interesting details like unique ids, execution time, etc about an event in question. Unlike logs which are discrete events, traces span over a time interval. They can be started at the beginning of an interesting event, and allow incrementally adding more context to it over the lifecycle of the trace.</p>
<p>A future post will talk more about leveraging tracing, and the benefits of using that model over manually logging information within applications, but there is still quite a bit we can do to improve logging and make them more useful for use in production systems.</p>
<h2 id="problems-with-the-default-async-logger">Problems with the default Async logger</h2>
<p><a href="https://opensource.janestreet.com/async/">Async</a> comes with a <a href="https://github.com/janestreet/async_unix/blob/ecf27931acaf003cf9a9aca2626d8ddfdacab193/src/log.mli">logging module</a> that is easy to use and provides a simple interface that allows logging at a specific level and attaching some tags along with a message payload.</p>
<pre data-lang="ocaml" class="language-ocaml z-code"><code class="language-ocaml" data-lang="ocaml"><span class="z-source z-ocaml"><span class="z-keyword z-other z-ocaml">open</span><span class="z-keyword z-operator z-prefix z-ocaml">!</span> <span class="z-entity z-name z-type z-variant z-ocaml">Core</span>
<span class="z-keyword z-other z-ocaml">open</span><span class="z-keyword z-operator z-prefix z-ocaml">!</span> <span class="z-entity z-name z-type z-variant z-ocaml">Async</span>

<span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">my_cool_function</span> <span class="z-variable z-parameter z-ocaml">user</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>info <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>This is a log message<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>debug <span class="z-entity z-name z-tag z-label z-ocaml">~tags<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-meta z-list z-ocaml"><span class="z-punctuation z-definition z-list z-begin z-ocaml">[</span><span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>user<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>, <span class="z-meta z-module-reference z-ocaml">User.</span>id user<span class="z-punctuation z-definition z-list z-end z-ocaml">]</span></span> <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Send confirmation email<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span><span class="z-punctuation z-separator z-ocaml">;</span>
    send_message user
</span></code></pre>
<p>This produces output that looks similar to:</p>
<pre class="z-code"><code><span class="z-text z-plain">2022-09-02 11:27:54.561533-04:00 Info This is a log message
2022-09-02 11:29:14.504046-04:00 Debug Send confirmation email -- [user: 12345]
</span></code></pre>
<p>While easy to use the default logger does have some limitations. The log output is easy to read for humans, but it requires post-processing to transform it into a format that's easier to parse. Async does support s-expressions as a log output which are easy to parse, but outside of the OCaml ecosystem s-expressions aren't common, and most centralized log management systems don't support s-expressions.</p>
<p>Log correlation is another challenge. In synchronous blocking systems transactions are served sequentially and as a result, it's easy to spot that any log event occurring after a transaction starts and before a transaction ends is related to the specific transaction. However, in libraries like <a href="https://opensource.janestreet.com/async/">Async</a> threading is non-preemptive and a single system thread can execute any number of user-mode &quot;threads&quot; asynchronously. In such systems, a transaction might not run to completion and instead yield control to the scheduler so a different transaction can run. This results in logs from concurrent transactions being printed interleaved.</p>
<p>We can simulate multiple transactions that yield control by adding some randomized delays within each independent task.</p>
<pre data-lang="ocaml" class="language-ocaml z-code"><code class="language-ocaml" data-lang="ocaml"><span class="z-source z-ocaml"><span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">interleaved</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
  <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>set_level <span class="z-entity z-name z-type z-variant z-polymorphic z-ocaml">`Debug</span><span class="z-punctuation z-separator z-ocaml">;</span>
  <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">task</span> <span class="z-variable z-parameter z-ocaml">identifier</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
    <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>bind <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>debug <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Starting task: %S<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span> identifier<span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>bind <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>debug <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished first stage<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>bind <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>debug <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished second stage<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>map <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>info <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished task<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>
  <span class="z-keyword z-other z-ocaml">in</span>
  <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>map <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> task <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>A<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>
  <span class="z-keyword z-operator z-ocaml">and</span> <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> task <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>B<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>
  <span class="z-keyword z-operator z-ocaml">and</span> <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> task <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>C<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span> <span class="z-keyword z-other z-ocaml">in</span>
  <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>info <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished all tasks<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>
<span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>
</span></code></pre>
<p>We might see output like this:</p>
<pre class="z-code"><code><span class="z-text z-plain">2022-09-02 13:45:41.775601-04:00 Debug Starting task: &quot;C&quot;
2022-09-02 13:45:42.121327-04:00 Debug Starting task: &quot;B&quot;
2022-09-02 13:45:42.223267-04:00 Debug Finished first stage
2022-09-02 13:45:42.313642-04:00 Debug Starting task: &quot;A&quot;
2022-09-02 13:45:42.429233-04:00 Debug Finished second stage
2022-09-02 13:45:42.775931-04:00 Debug Finished first stage
2022-09-02 13:45:42.961856-04:00 Debug Finished second stage
2022-09-02 13:45:42.969699-04:00 Debug Finished first stage
2022-09-02 13:45:43.247551-04:00 Info Finished task
2022-09-02 13:45:43.288733-04:00 Debug Finished second stage
2022-09-02 13:45:43.359040-04:00 Info Finished task
2022-09-02 13:45:43.735843-04:00 Info Finished task
2022-09-02 13:45:43.735907-04:00 Info Finished all tasks
</span></code></pre>
<p>The default output has details from each run of the task, but it's hard to tell whether the log lines about starting and finishing the stages belong to transactions A, B, or C.</p>
<h2 id="better-logging-configuration">Better Logging configuration</h2>
<p>We've seen some limitations of the out-of-the-box configuration of Async's logging module, but Async provides an API for controlling how log messages are rendered and it can work with user-provided logging output implementations. Let us use this ability to address the two problems we talked about by implementing a machine-readable output format for log messages and a system for adding unique identifiers for transactions within log messages.</p>
<h3 id="json-formatted-logs">JSON formatted logs</h3>
<p>Using a centralized logging system is typical in real-world deployments, as it can help to efficiently sift through the logs originating within the many separate applications running within the system. <a href="https://www.elastic.co/observability/log-monitoring">Elasticsearch</a> is one such system and the example we'll use in this post. Elasticsearch can ingest logs and provides a scalable interface for monitoring logs. It is possible to post-process application logs by parsing, transforming, and enriching logs before they get indexed by Elasticsearch, but we will instead configure Async's logger to output JSON-formatted logs. JSON objects are easy to parse and will help avoid the need for potentially brittle regex-based parsing to extract data from logs.</p>
<pre data-lang="ocaml" class="language-ocaml z-code"><code class="language-ocaml" data-lang="ocaml"><span class="z-source z-ocaml"><span class="z-meta z-module z-ocaml"><span class="z-keyword z-other z-module-definition z-ocaml">module</span> <span class="z-entity z-name z-type z-module z-ocaml">Output</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> <span class="z-meta z-module z-structure z-ocaml"><span class="z-keyword z-other z-module z-structure z-ocaml">struct</span>
  <span class="z-comment z-block z-ocaml">(* [Async_unix.Writer.t](https://github.com/janestreet/async_unix/blob/ecf27931acaf003cf9a9aca2626d8ddfdacab193/src/writer.mli)
     acts as the sink for all log messages generated by a Logger. *)</span>
  <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">json</span> <span class="z-meta z-parameter z-type-constrained z-ocaml"><span class="z-punctuation z-section z-type-constraint z-ocaml">(</span><span class="z-variable z-parameter z-ocaml">writer</span> <span class="z-storage z-type z-ocaml"><span class="z-punctuation z-separator z-type-constraint z-ocaml">:</span> Async_unix.Writer.t</span><span class="z-punctuation z-section z-type-constraint z-ocaml">)</span></span> <span class="z-keyword z-operator z-ocaml">=</span></span>
    <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">log_level_to_string</span> <span class="z-keyword z-operator z-ocaml">=</span></span> <span class="z-meta z-pattern-match z-ocaml"><span class="z-keyword z-control z-match-definition z-ocaml">function</span>
      </span><span class="z-meta z-pattern-match z-ocaml"><span class="z-keyword z-control z-match-definition z-ocaml">|</span> <span class="z-entity z-name z-type z-variant z-ocaml">None</span> <span class="z-punctuation z-separator z-match-definition z-ocaml">-&gt;</span></span> <span class="z-entity z-name z-type z-variant z-polymorphic z-ocaml">`Null</span>
      <span class="z-meta z-pattern-match z-ocaml"><span class="z-keyword z-control z-match-definition z-ocaml">|</span> <span class="z-entity z-name z-type z-variant z-ocaml">Some</span> <span class="z-variable z-parameter z-ocaml">level</span> <span class="z-punctuation z-separator z-match-definition z-ocaml">-&gt;</span></span> <span class="z-entity z-name z-type z-variant z-polymorphic z-ocaml">`String</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Level.</span>to_string level)</span>
    <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Output.</span>create
      <span class="z-entity z-name z-tag z-label z-ocaml">~flush<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span> <span class="z-meta z-module-reference z-ocaml">Writer.</span>flushed writer<span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span>
      <span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-variable z-parameter z-ocaml">messages</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span>
        <span class="z-meta z-module-reference z-ocaml">Queue.</span>iter messages <span class="z-entity z-name z-tag z-label z-ocaml">~f<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-variable z-parameter z-ocaml">message</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span>
          <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">tags</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span>
            <span class="z-keyword z-control z-ocaml">match</span> <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Message.</span>tags message <span class="z-meta z-pattern-match z-ocaml"><span class="z-keyword z-control z-match-definition z-ocaml">with</span>
            </span><span class="z-meta z-pattern-match z-ocaml"><span class="z-keyword z-control z-match-definition z-ocaml">|</span> <span class="z-constant z-language z-pseudo-variable z-ocaml">[<span class="z-meta z-empty-typing-pair z-ocaml">]</span></span> <span class="z-punctuation z-separator z-match-definition z-ocaml">-&gt;</span></span> <span class="z-constant z-language z-pseudo-variable z-ocaml">[<span class="z-meta z-empty-typing-pair z-ocaml">]</span></span>
            <span class="z-meta z-pattern-match z-ocaml"><span class="z-keyword z-control z-match-definition z-ocaml">|</span> <span class="z-variable z-parameter z-ocaml">tags</span> <span class="z-punctuation z-separator z-match-definition z-ocaml">-&gt;</span></span> <span class="z-meta z-module-reference z-ocaml">List.</span>map tags <span class="z-entity z-name z-tag z-label z-ocaml">~f<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-variable z-parameter z-ocaml">k</span>, <span class="z-variable z-parameter z-ocaml">v</span>)</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span> k, <span class="z-entity z-name z-type z-variant z-polymorphic z-ocaml">`String</span> v<span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span>
          <span class="z-keyword z-other z-ocaml">in</span>
          <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">message</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span>
            <span class="z-meta z-paren-group z-ocaml">(<span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>@timestamp<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>, <span class="z-entity z-name z-type z-variant z-polymorphic z-ocaml">`String</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Time.</span>to_string_utc <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Message.</span>time message)</span>)</span>)</span>
            <span class="z-punctuation z-definition z-list z-constructor z-ocaml">::</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>message<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>, <span class="z-entity z-name z-type z-variant z-polymorphic z-ocaml">`String</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Message.</span>message message)</span>)</span>
            <span class="z-punctuation z-definition z-list z-constructor z-ocaml">::</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>log.level<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>, log_level_to_string <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Message.</span>level message)</span>)</span>
            <span class="z-punctuation z-definition z-list z-constructor z-ocaml">::</span> tags
          <span class="z-keyword z-other z-ocaml">in</span>
          <span class="z-meta z-module-reference z-ocaml">Writer.</span>write_line writer <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Jsonaf.</span>to_string <span class="z-meta z-paren-group z-ocaml">(<span class="z-entity z-name z-type z-variant z-polymorphic z-ocaml">`Assoc</span> message)</span>)</span><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span><span class="z-punctuation z-separator z-ocaml">;</span>
        <span class="z-meta z-module-reference z-ocaml">Deferred.</span><span class="z-storage z-type z-ocaml">unit</span><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span>
  <span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>
<span class="z-keyword z-other z-module z-structure z-ocaml">end</span></span>

<span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">json_logs</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
  <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">stdout</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Lazy.</span>force <span class="z-meta z-module-reference z-ocaml">Writer.</span>stdout <span class="z-keyword z-other z-ocaml">in</span>
  <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>set_output <span class="z-meta z-list z-ocaml"><span class="z-punctuation z-definition z-list z-begin z-ocaml">[</span> <span class="z-meta z-module-reference z-ocaml">Output.</span>json stdout <span class="z-punctuation z-definition z-list z-end z-ocaml">]</span></span><span class="z-punctuation z-separator z-ocaml">;</span>
  <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>set_level <span class="z-entity z-name z-type z-variant z-polymorphic z-ocaml">`Debug</span><span class="z-punctuation z-separator z-ocaml">;</span>
  <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">task</span> <span class="z-variable z-parameter z-ocaml">identifier</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
    <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>bind <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>debug <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Starting task: %s<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span> identifier<span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>bind <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>debug <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished first stage<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>bind <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>debug <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished second stage<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>map <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>info <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished task<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>
  <span class="z-keyword z-other z-ocaml">in</span>
  <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>map <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> task <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>A<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>
  <span class="z-keyword z-operator z-ocaml">and</span> <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> task <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>B<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>
  <span class="z-keyword z-operator z-ocaml">and</span> <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> task <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>C<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span> <span class="z-keyword z-other z-ocaml">in</span>
  <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>info <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished all tasks<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>
<span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>
</span></code></pre>
<p>We might see output like this:</p>
<pre class="z-code"><code><span class="z-text z-plain">{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:21.329844Z&quot;,&quot;message&quot;:&quot;Starting task: C&quot;,&quot;log.level&quot;:&quot;Debug&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:21.711095Z&quot;,&quot;message&quot;:&quot;Starting task: A&quot;,&quot;log.level&quot;:&quot;Debug&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:21.864161Z&quot;,&quot;message&quot;:&quot;Starting task: B&quot;,&quot;log.level&quot;:&quot;Debug&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:21.903899Z&quot;,&quot;message&quot;:&quot;Finished first stage&quot;,&quot;log.level&quot;:&quot;Debug&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:22.342807Z&quot;,&quot;message&quot;:&quot;Finished first stage&quot;,&quot;log.level&quot;:&quot;Debug&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:22.408197Z&quot;,&quot;message&quot;:&quot;Finished second stage&quot;,&quot;log.level&quot;:&quot;Debug&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:22.788932Z&quot;,&quot;message&quot;:&quot;Finished first stage&quot;,&quot;log.level&quot;:&quot;Debug&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:22.928766Z&quot;,&quot;message&quot;:&quot;Finished task&quot;,&quot;log.level&quot;:&quot;Info&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:23.128315Z&quot;,&quot;message&quot;:&quot;Finished second stage&quot;,&quot;log.level&quot;:&quot;Debug&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:23.546877Z&quot;,&quot;message&quot;:&quot;Finished second stage&quot;,&quot;log.level&quot;:&quot;Debug&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:24.009860Z&quot;,&quot;message&quot;:&quot;Finished task&quot;,&quot;log.level&quot;:&quot;Info&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:24.109893Z&quot;,&quot;message&quot;:&quot;Finished task&quot;,&quot;log.level&quot;:&quot;Info&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 18:13:24.109972Z&quot;,&quot;message&quot;:&quot;Finished all tasks&quot;,&quot;log.level&quot;:&quot;Info&quot;}
</span></code></pre>
<h3 id="unique-identifiers-for-transactions">Unique identifiers for transactions</h3>
<p>We now have JSON formatted logs that are easy to parse, but we still have the problem caused by interleaved logs as we don't have an easy way to correlate logs with specific transactions. Robust distributed log correlation is a bigger problem that deserves its own detailed post, but we can still implement techniques to implement a fairly usable context propagation for log messages. </p>
<p>A naive approach would be to manually forward a unique id to each transaction and manually forward the identifier at each call site for a logging function. This approach is brittle as it relies on users to remember to use the unique identifier when logging something, and this needs us to re-write all functions that perform logging to also accept an additional argument that represents a unique identifier.</p>
<p>A more robust approach would be if every function that needed to log something could look up a unique identifier that's currently active in its context. Blocking applications that use pre-emptive threads can rely on thread-local-storage for this use case and maintain a stack of context ids that can be used by the logging system to determine the current active context id and automatically attach it to a log event. This approach doesn't work for user-mode threaded systems as a single thread can switch between various tasks or systems where a task could potentially jump across threads. Async provides a solution for such context propagation that works at the task level and is naturally called <a href="https://github.com/janestreet/async_kernel/blob/a6bd9b2074b9af3b0c3498a7327ea542909ea211/src/execution_context.mli">ExecutionContext</a>. Every Async task runs within an execution context, and the context object offers users to append some metadata to its local storage.</p>
<p>The first task is to come up with a unique identifier that we'll use to tag log messages. We could use UUIDs, but a better option might be to use a random 16-byte identifier that's compliant with the W3C recommendation for propagating distributed tracing contexts across applications. One potential implementation of this random ID generation can be seen below:</p>
<pre data-lang="ocaml" class="language-ocaml z-code"><code class="language-ocaml" data-lang="ocaml"><span class="z-source z-ocaml"><span class="z-keyword z-other z-ocaml">open</span><span class="z-keyword z-operator z-prefix z-ocaml">!</span> <span class="z-entity z-name z-type z-variant z-ocaml">Core</span>

<span class="z-meta z-module z-ocaml"><span class="z-keyword z-other z-module-definition z-ocaml">module</span> <span class="z-entity z-name z-type z-module z-ocaml">Id</span> <span class="z-punctuation z-separator z-module-definition z-ocaml">:</span> </span><span class="z-meta z-module z-signature z-ocaml"><span class="z-keyword z-other z-module z-signature z-ocaml">sig</span>
<span class="z-meta z-type-definition-group z-ocaml">  <span class="z-meta z-type-definition z-ocaml"><span class="z-keyword z-other z-type-definition z-ocaml">type</span> <span class="z-storage z-type z-ocaml">t [@@deriving equal]
</span></span>
</span>  <span class="z-meta z-module z-signature z-val z-ocaml"><span class="z-keyword z-other z-ocaml">val</span> <span class="z-entity z-name z-type z-value-signature z-ocaml">create</span> <span class="z-punctuation z-separator z-type-constraint z-ocaml">:</span> <span class="z-storage z-type z-ocaml">unit</span> <span class="z-punctuation z-separator z-function-return z-ocaml">-&gt;</span> <span class="z-storage z-type z-ocaml">t</span>
  </span><span class="z-meta z-module z-signature z-val z-ocaml"><span class="z-keyword z-other z-ocaml">val</span> <span class="z-entity z-name z-type z-value-signature z-ocaml">to_hex</span> <span class="z-punctuation z-separator z-type-constraint z-ocaml">:</span> <span class="z-storage z-type z-ocaml">t</span> <span class="z-punctuation z-separator z-function-return z-ocaml">-&gt;</span> <span class="z-storage z-type z-ocaml">string</span>
</span><span class="z-keyword z-other z-module z-signature z-ocaml">end</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> <span class="z-meta z-module z-structure z-ocaml"><span class="z-keyword z-other z-module z-structure z-ocaml">struct</span>
  <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">fill_64_bits</span> <span class="z-variable z-parameter z-ocaml">state</span> <span class="z-variable z-parameter z-ocaml">buf</span> <span class="z-variable z-parameter z-labeled z-ocaml"><span class="z-punctuation z-definition z-labeled-parameter z-ocaml">~</span><span class="z-entity z-name z-tag z-label z-ocaml">pos</span></span> <span class="z-keyword z-operator z-ocaml">=</span></span>
    <span class="z-keyword z-other z-ocaml">assert</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Bytes.</span>length buf <span class="z-keyword z-operator z-infix z-ocaml">-</span> pos <span class="z-keyword z-operator z-symbol z-ocaml">&gt;</span><span class="z-keyword z-operator z-infix z-ocaml">=</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">8</span>)</span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">a</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Random.</span><span class="z-meta z-module-reference z-ocaml">State.</span>bits state <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">b</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Random.</span><span class="z-meta z-module-reference z-ocaml">State.</span>bits state <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">c</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Random.</span><span class="z-meta z-module-reference z-ocaml">State.</span>bits state <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Bytes.</span>unsafe_set buf pos <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Char.</span>of_int_exn <span class="z-meta z-paren-group z-ocaml">(a <span class="z-keyword z-operator z-ocaml">land</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-ocaml"><span class="z-punctuation z-definition z-numeric z-base z-ocaml">0x</span>FF</span>)</span>)</span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-meta z-module-reference z-ocaml">Bytes.</span>unsafe_set buf <span class="z-meta z-paren-group z-ocaml">(pos <span class="z-keyword z-operator z-infix z-ocaml">+</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">1</span>)</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Char.</span>of_int_exn <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-paren-group z-ocaml">(a <span class="z-keyword z-operator z-ocaml">lsr</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">8</span>)</span> <span class="z-keyword z-operator z-ocaml">land</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-ocaml"><span class="z-punctuation z-definition z-numeric z-base z-ocaml">0x</span>FF</span>)</span>)</span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-meta z-module-reference z-ocaml">Bytes.</span>unsafe_set buf <span class="z-meta z-paren-group z-ocaml">(pos <span class="z-keyword z-operator z-infix z-ocaml">+</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">2</span>)</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Char.</span>of_int_exn <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-paren-group z-ocaml">(a <span class="z-keyword z-operator z-ocaml">lsr</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">16</span>)</span> <span class="z-keyword z-operator z-ocaml">land</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-ocaml"><span class="z-punctuation z-definition z-numeric z-base z-ocaml">0x</span>FF</span>)</span>)</span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-meta z-module-reference z-ocaml">Bytes.</span>unsafe_set buf <span class="z-meta z-paren-group z-ocaml">(pos <span class="z-keyword z-operator z-infix z-ocaml">+</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">3</span>)</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Char.</span>of_int_exn <span class="z-meta z-paren-group z-ocaml">(b <span class="z-keyword z-operator z-ocaml">land</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-ocaml"><span class="z-punctuation z-definition z-numeric z-base z-ocaml">0x</span>FF</span>)</span>)</span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-meta z-module-reference z-ocaml">Bytes.</span>unsafe_set buf <span class="z-meta z-paren-group z-ocaml">(pos <span class="z-keyword z-operator z-infix z-ocaml">+</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">4</span>)</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Char.</span>of_int_exn <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-paren-group z-ocaml">(b <span class="z-keyword z-operator z-ocaml">lsr</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">8</span>)</span> <span class="z-keyword z-operator z-ocaml">land</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-ocaml"><span class="z-punctuation z-definition z-numeric z-base z-ocaml">0x</span>FF</span>)</span>)</span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-meta z-module-reference z-ocaml">Bytes.</span>unsafe_set buf <span class="z-meta z-paren-group z-ocaml">(pos <span class="z-keyword z-operator z-infix z-ocaml">+</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">5</span>)</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Char.</span>of_int_exn <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-paren-group z-ocaml">(b <span class="z-keyword z-operator z-ocaml">lsr</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">16</span>)</span> <span class="z-keyword z-operator z-ocaml">land</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-ocaml"><span class="z-punctuation z-definition z-numeric z-base z-ocaml">0x</span>FF</span>)</span>)</span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-meta z-module-reference z-ocaml">Bytes.</span>unsafe_set buf <span class="z-meta z-paren-group z-ocaml">(pos <span class="z-keyword z-operator z-infix z-ocaml">+</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">6</span>)</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Char.</span>of_int_exn <span class="z-meta z-paren-group z-ocaml">(c <span class="z-keyword z-operator z-ocaml">land</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-ocaml"><span class="z-punctuation z-definition z-numeric z-base z-ocaml">0x</span>FF</span>)</span>)</span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-meta z-module-reference z-ocaml">Bytes.</span>unsafe_set buf <span class="z-meta z-paren-group z-ocaml">(pos <span class="z-keyword z-operator z-infix z-ocaml">+</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">7</span>)</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Char.</span>of_int_exn <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-paren-group z-ocaml">(c <span class="z-keyword z-operator z-ocaml">lsr</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">8</span>)</span> <span class="z-keyword z-operator z-ocaml">land</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-ocaml"><span class="z-punctuation z-definition z-numeric z-base z-ocaml">0x</span>FF</span>)</span>)</span>
  <span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>

  <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">fill_128_bits</span> <span class="z-variable z-parameter z-ocaml">state</span> <span class="z-variable z-parameter z-ocaml">buf</span> <span class="z-variable z-parameter z-labeled z-ocaml"><span class="z-punctuation z-definition z-labeled-parameter z-ocaml">~</span><span class="z-entity z-name z-tag z-label z-ocaml">pos</span></span> <span class="z-keyword z-operator z-ocaml">=</span></span>
    fill_64_bits state buf <span class="z-entity z-name z-tag z-label z-ocaml">~pos</span><span class="z-punctuation z-separator z-ocaml">;</span>
    fill_64_bits state buf <span class="z-entity z-name z-tag z-label z-ocaml">~pos<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-meta z-paren-group z-ocaml">(pos <span class="z-keyword z-operator z-infix z-ocaml">+</span> <span class="z-constant z-numeric z-integer z-decimal z-ocaml">8</span>)</span>
  <span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>

<span class="z-meta z-type-definition-group z-ocaml">  <span class="z-meta z-type-definition z-ocaml"><span class="z-keyword z-other z-type-definition z-ocaml">type</span> <span class="z-storage z-type z-ocaml">t </span><span class="z-punctuation z-separator z-type-definition z-ocaml">=</span> <span class="z-storage z-type z-ocaml">string</span> <span class="z-meta z-polymorphic-variant z-definition z-ocaml"><span class="z-punctuation z-definition z-polymorphic-variant z-ocaml">[</span><span class="z-keyword z-operator z-infix z-ocaml">@@</span>deriving <span class="z-storage z-type z-ocaml">equal</span><span class="z-punctuation z-definition z-polymorphic-variant z-ocaml">]</span></span>
</span>
</span>  <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">create</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
    <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">b</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Bytes.</span>create <span class="z-constant z-numeric z-integer z-decimal z-ocaml">16</span> <span class="z-keyword z-other z-ocaml">in</span>
    fill_128_bits <span class="z-meta z-module-reference z-ocaml">Random.</span><span class="z-meta z-module-reference z-ocaml">State.</span>default b <span class="z-entity z-name z-tag z-label z-ocaml">~pos<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-constant z-numeric z-integer z-decimal z-ocaml">0</span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-meta z-module-reference z-ocaml">Bytes.</span>unsafe_to_string <span class="z-entity z-name z-tag z-label z-ocaml">~no_mutation_while_string_reachable<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span>b
  <span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>

  <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">to_hex</span> <span class="z-variable z-parameter z-ocaml">t</span> <span class="z-keyword z-operator z-ocaml">=</span></span> <span class="z-meta z-module-reference z-ocaml">Hex_encode.</span>to_hex <span class="z-entity z-name z-tag z-label z-ocaml">~case<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-entity z-name z-type z-variant z-polymorphic z-ocaml">`Lowercase</span> t
<span class="z-keyword z-other z-module z-structure z-ocaml">end</span></span>
</span></code></pre>
<p>With the ID generation out of the way, we can now look at automatic ID context propagation for async tasks. Instead of implementing a limited solution that just works for IDs, we will implement a way to propagate generic log tags. This can be used to progate other metadata in addition to the ID that could be useful to append to every log message within a transaction.</p>
<pre data-lang="ocaml" class="language-ocaml z-code"><code class="language-ocaml" data-lang="ocaml"><span class="z-source z-ocaml"><span class="z-meta z-module z-ocaml"><span class="z-keyword z-other z-module-definition z-ocaml">module</span> <span class="z-entity z-name z-type z-module z-ocaml">Logger</span> <span class="z-punctuation z-separator z-module-definition z-ocaml">:</span> </span><span class="z-meta z-module z-signature z-ocaml"><span class="z-keyword z-other z-module z-signature z-ocaml">sig</span>
  <span class="z-keyword z-other z-ocaml">include</span> <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-entity z-name z-type z-variant z-ocaml">Global_intf</span>

  <span class="z-meta z-module z-signature z-val z-ocaml"><span class="z-keyword z-other z-ocaml">val</span> <span class="z-entity z-name z-type z-value-signature z-ocaml">with_transaction</span> <span class="z-punctuation z-separator z-type-constraint z-ocaml">:</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-storage z-type z-ocaml">unit</span> <span class="z-punctuation z-separator z-function-return z-ocaml">-&gt;</span> <span class="z-storage z-type z-ocaml">&#39;a</span> <span class="z-meta z-module z-type z-ocaml"><span class="z-support z-other z-module z-ocaml">Deferred</span><span class="z-storage z-type z-module z-ocaml">.t</span></span>)</span> <span class="z-punctuation z-separator z-function-return z-ocaml">-&gt;</span> <span class="z-storage z-type z-ocaml">&#39;a</span> <span class="z-meta z-module z-type z-ocaml"><span class="z-support z-other z-module z-ocaml">Deferred</span><span class="z-storage z-type z-module z-ocaml">.t</span></span>
  </span><span class="z-meta z-module z-signature z-val z-ocaml"><span class="z-keyword z-other z-ocaml">val</span> <span class="z-entity z-name z-type z-value-signature z-ocaml">log_transform</span> <span class="z-punctuation z-separator z-type-constraint z-ocaml">:</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module z-type z-ocaml"><span class="z-support z-other z-module z-ocaml">Log.Message</span><span class="z-storage z-type z-module z-ocaml">.t</span></span> <span class="z-punctuation z-separator z-function-return z-ocaml">-&gt;</span> <span class="z-meta z-module z-type z-ocaml"><span class="z-support z-other z-module z-ocaml">Log.Message</span><span class="z-storage z-type z-module z-ocaml">.t</span></span>)</span> <span class="z-storage z-type z-ocaml">option</span>
</span><span class="z-keyword z-other z-module z-signature z-ocaml">end</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> <span class="z-meta z-module z-structure z-ocaml"><span class="z-keyword z-other z-module z-structure z-ocaml">struct</span>
  <span class="z-comment z-block z-ocaml">(* `Make_global` generates a new unique singleton logging module. It can be useful for
     libraries to generate a unique Logger instead of pushing content to the application&#39;s
     global logger (`Log.Global`) *)</span>
  <span class="z-keyword z-other z-ocaml">include</span> <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-entity z-name z-type z-variant z-ocaml">Make_global</span> <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span>

  <span class="z-comment z-block z-ocaml">(* [tak_key] is a unique identifier that associates log tags within an execution
     context&#39;s local storage. *)</span>
  <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">tag_key</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Univ_map.</span><span class="z-meta z-module-reference z-ocaml">Key.</span>create <span class="z-entity z-name z-tag z-label z-ocaml">~name<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>log_tags<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span> <span class="z-meta z-list z-ocaml"><span class="z-punctuation z-definition z-list z-begin z-ocaml">[</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>sexp_of: <span class="z-meta z-paren-group z-ocaml">(<span class="z-storage z-type z-ocaml">string</span> <span class="z-keyword z-operator z-infix z-ocaml">*</span> <span class="z-storage z-type z-ocaml">string</span>)</span> <span class="z-storage z-type z-ocaml">list</span><span class="z-punctuation z-definition z-list z-end z-ocaml">]</span></span>

  <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">merge_tags</span> <span class="z-variable z-parameter z-ocaml">left</span> <span class="z-variable z-parameter z-ocaml">right</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
    <span class="z-meta z-list z-ocaml"><span class="z-punctuation z-definition z-list z-begin z-ocaml">[</span> left<span class="z-punctuation z-separator z-ocaml">;</span> right <span class="z-punctuation z-definition z-list z-end z-ocaml">]</span></span>
    <span class="z-keyword z-operator z-infix z-ocaml">|&gt;</span> <span class="z-meta z-module-reference z-ocaml">List.</span>concat
    <span class="z-keyword z-operator z-infix z-ocaml">|&gt;</span> <span class="z-meta z-module-reference z-ocaml">List.</span>sort <span class="z-entity z-name z-tag z-label z-ocaml">~compare<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-variable z-parameter z-ocaml">key1</span>, <span class="z-variable z-parameter z-ocaml">_</span>)</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-variable z-parameter z-ocaml">key2</span>, <span class="z-variable z-parameter z-ocaml">_</span>)</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span> <span class="z-meta z-module-reference z-ocaml">String.</span><span class="z-meta z-module-reference z-ocaml">Caseless.</span>compare key1 key2<span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span>
    <span class="z-comment z-block z-ocaml">(* When merging the existing tags within an execution context&#39;s local storage with
       user-provided tags, we always favor the user-provided tag if there&#39;s a clash
       between its key and an existing key within the local storage. *)</span>
    <span class="z-keyword z-operator z-infix z-ocaml">|&gt;</span> <span class="z-meta z-module-reference z-ocaml">List.</span>remove_consecutive_duplicates
         <span class="z-entity z-name z-tag z-label z-ocaml">~which_to_keep<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-entity z-name z-type z-variant z-polymorphic z-ocaml">`Last</span>
         <span class="z-entity z-name z-tag z-label z-ocaml">~equal<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-variable z-parameter z-ocaml">key1</span>, <span class="z-variable z-parameter z-ocaml">_</span>)</span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-variable z-parameter z-ocaml">key2</span>, <span class="z-variable z-parameter z-ocaml">_</span>)</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span> <span class="z-meta z-module-reference z-ocaml">String.</span><span class="z-meta z-module-reference z-ocaml">Caseless.</span>equal key1 key2<span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span>
  <span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>

  <span class="z-comment z-block z-ocaml">(* [with_tags] runs the user-provided function within an execution context where the
     local storage contains a tag list created after merging the user-provided tags with
     the existing tags (if any) within the call site&#39;s current execution context. *)</span>
  <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">with_tags</span> <span class="z-variable z-parameter z-ocaml">tags</span> <span class="z-variable z-parameter z-ocaml">f</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
    <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">existing_tags</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Option.</span>value <span class="z-entity z-name z-tag z-label z-ocaml">~default<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-constant z-language z-pseudo-variable z-ocaml">[<span class="z-meta z-empty-typing-pair z-ocaml">]</span></span> <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Scheduler.</span>find_local tag_key)</span> <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Scheduler.</span>with_local
      tag_key
      <span class="z-meta z-paren-group z-ocaml">(<span class="z-entity z-name z-type z-variant z-ocaml">Some</span> <span class="z-meta z-paren-group z-ocaml">(merge_tags existing_tags tags)</span>)</span>
      <span class="z-entity z-name z-tag z-label z-ocaml">~f<span class="z-punctuation z-separator z-argument-label z-ocaml">:</span></span><span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span> <span class="z-meta z-module-reference z-ocaml">Scheduler.</span>within&#39; <span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span> f <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span>
  <span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>

  <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">add_tags_if_present</span> <span class="z-variable z-parameter z-ocaml">existing_tags</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
    <span class="z-keyword z-control z-ocaml">match</span> <span class="z-meta z-module-reference z-ocaml">Scheduler.</span>find_local tag_key <span class="z-meta z-pattern-match z-ocaml"><span class="z-keyword z-control z-match-definition z-ocaml">with</span>
    </span><span class="z-meta z-pattern-match z-ocaml"><span class="z-keyword z-control z-match-definition z-ocaml">|</span> <span class="z-entity z-name z-type z-variant z-ocaml">None</span> <span class="z-punctuation z-separator z-match-definition z-ocaml">-&gt;</span></span> existing_tags
    <span class="z-meta z-pattern-match z-ocaml"><span class="z-keyword z-control z-match-definition z-ocaml">|</span> <span class="z-entity z-name z-type z-variant z-ocaml">Some</span> <span class="z-variable z-parameter z-ocaml">tags</span> <span class="z-punctuation z-separator z-match-definition z-ocaml">-&gt;</span></span> merge_tags tags existing_tags
  <span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>

  <span class="z-comment z-block z-ocaml">(* [log_transform] is called by Async&#39;s logging system and allows us to transform a log
     message by automatically attaching log tags if some tags exist in the execution
     context&#39;s local storage. The transform merges the tags within the local storage with
     any new tags provided directly at the call site of a log message. *)</span>
  <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">log_transform</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span>
    <span class="z-entity z-name z-type z-variant z-ocaml">Some</span>
      <span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-variable z-parameter z-ocaml">msg</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span>
        <span class="z-keyword z-other z-ocaml">let</span> <span class="z-keyword z-control z-import z-ocaml">open</span> Log.Message <span class="z-keyword z-other z-ocaml">in</span>
        <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">level</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> level msg
        <span class="z-keyword z-other z-ocaml">and</span> <span class="z-variable z-other z-constant z-ocaml">raw_message</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> raw_message msg
        <span class="z-keyword z-other z-ocaml">and</span> <span class="z-variable z-other z-constant z-ocaml">tags</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> add_tags_if_present <span class="z-meta z-paren-group z-ocaml">(tags msg)</span>
        <span class="z-keyword z-other z-ocaml">and</span> <span class="z-variable z-other z-constant z-ocaml">time</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> time msg <span class="z-keyword z-other z-ocaml">in</span>
        create ?level <span class="z-entity z-name z-tag z-label z-ocaml">~tags</span> <span class="z-entity z-name z-tag z-label z-ocaml">~time</span> raw_message<span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span>
  <span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>

  <span class="z-comment z-block z-ocaml">(* [with_transaction] generates a new random transaction ID and runs the user-provided
     function within an execution context with a trace id tag stored in its local
     storage. *)</span>
  <span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">with_transaction</span> <span class="z-variable z-parameter z-ocaml">f</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
    <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">id</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Id.</span>to_hex <span class="z-meta z-paren-group z-ocaml">(<span class="z-meta z-module-reference z-ocaml">Id.</span>create <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span>)</span> <span class="z-keyword z-other z-ocaml">in</span>
    with_tags <span class="z-meta z-list z-ocaml"><span class="z-punctuation z-definition z-list z-begin z-ocaml">[</span> <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>trace.id<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span>, id <span class="z-punctuation z-definition z-list z-end z-ocaml">]</span></span> <span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span> f <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span>
  <span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>

  <span class="z-keyword z-other z-ocaml">let</span> <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span>
    <span class="z-comment z-block z-ocaml">(* Setup log transform at application startup. We also set the transform the global
       logger so tag propagation works within the global logger as well. *)</span>
    set_transform log_transform<span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>set_transform log_transform
  <span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>
<span class="z-keyword z-other z-module z-structure z-ocaml">end</span></span>
</span></code></pre>
<p>Example showing the use of these new logging utilities:</p>
<pre data-lang="ocaml" class="language-ocaml z-code"><code class="language-ocaml" data-lang="ocaml"><span class="z-source z-ocaml"><span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">task</span> <span class="z-variable z-parameter z-ocaml">identifier</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
  <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>bind <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
  <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>debug <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Starting task: %s<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span> identifier<span class="z-punctuation z-separator z-ocaml">;</span>
  <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>bind <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
  <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>debug <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished first stage: %s<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span> identifier<span class="z-punctuation z-separator z-ocaml">;</span>
  <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>bind <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
  <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>debug <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished second stage: %s<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span> identifier<span class="z-punctuation z-separator z-ocaml">;</span>
  <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>map <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> sleep_random <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
  <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>info <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished task: %s<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span> identifier
<span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>

<span class="z-meta z-function z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">let</span> <span class="z-entity z-name z-function z-ocaml">main</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-keyword z-operator z-ocaml">=</span></span>
  <span class="z-keyword z-other z-ocaml">let</span> <span class="z-variable z-other z-constant z-ocaml">stdout</span> <span class="z-keyword z-operator z-assignment z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Lazy.</span>force <span class="z-meta z-module-reference z-ocaml">Writer.</span>stdout <span class="z-keyword z-other z-ocaml">in</span>
  <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>set_output <span class="z-meta z-list z-ocaml"><span class="z-punctuation z-definition z-list z-begin z-ocaml">[</span> <span class="z-meta z-module-reference z-ocaml">Output.</span>json stdout <span class="z-punctuation z-definition z-list z-end z-ocaml">]</span></span><span class="z-punctuation z-separator z-ocaml">;</span>
  <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>set_level <span class="z-entity z-name z-type z-variant z-polymorphic z-ocaml">`Debug</span><span class="z-punctuation z-separator z-ocaml">;</span>
  <span class="z-meta z-module-reference z-ocaml">Logger.</span>with_transaction <span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>debug <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Starting tasks<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span><span class="z-punctuation z-separator z-ocaml">;</span>
    <span class="z-keyword z-other z-ocaml">let</span><span class="z-keyword z-operator z-infix z-ocaml">%</span>map <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Logger.</span>with_transaction <span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span> task <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>A<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span>
    <span class="z-keyword z-operator z-ocaml">and</span> <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Logger.</span>with_transaction <span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span> task <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>B<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span>
    <span class="z-keyword z-operator z-ocaml">and</span> <span class="z-constant z-language z-pseudo-variable z-ocaml">(<span class="z-meta z-empty-typing-pair z-parens z-ocaml">)</span></span> <span class="z-keyword z-operator z-infix z-ocaml">=</span> <span class="z-meta z-module-reference z-ocaml">Logger.</span>with_transaction <span class="z-meta z-function z-anonymous z-ocaml"><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">(</span><span class="z-meta z-function z-anonymous z-definition z-ocaml"><span class="z-keyword z-other z-function-definition z-ocaml">fun</span> <span class="z-variable z-parameter z-unit z-ocaml">()</span> <span class="z-punctuation z-separator z-function-definition z-ocaml">-&gt;</span></span> task <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>C<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span> <span class="z-keyword z-other z-ocaml">in</span>
    <span class="z-meta z-module-reference z-ocaml">Log.</span><span class="z-meta z-module-reference z-ocaml">Global.</span>info <span class="z-string z-quoted z-double z-ocaml"><span class="z-punctuation z-definition z-string z-begin z-ocaml">&quot;</span>Finished all tasks<span class="z-punctuation z-definition z-string z-end z-ocaml">&quot;</span></span><span class="z-punctuation z-definition z-function z-anonymous z-ocaml">)</span></span>
<span class="z-punctuation z-terminator z-expression z-ocaml">;;</span>
</span></code></pre>
<p>We might see output like this:</p>
<pre class="z-code"><code><span class="z-text z-plain">{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:48.327648Z&quot;,&quot;message&quot;:&quot;Starting tasks&quot;,&quot;log.level&quot;:&quot;Debug&quot;,&quot;trace.id&quot;:&quot;a8be55ee47252520baa1dcae035d8170&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:48.481808Z&quot;,&quot;message&quot;:&quot;Starting task: B&quot;,&quot;log.level&quot;:&quot;Debug&quot;,&quot;trace.id&quot;:&quot;8f70a70a2e3f49528aa04ad35208b3fb&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:48.941080Z&quot;,&quot;message&quot;:&quot;Starting task: C&quot;,&quot;log.level&quot;:&quot;Debug&quot;,&quot;trace.id&quot;:&quot;ddbf3a089800458b85dea9b9f7d8d0e1&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:48.941116Z&quot;,&quot;message&quot;:&quot;Finished first stage: B&quot;,&quot;log.level&quot;:&quot;Debug&quot;,&quot;trace.id&quot;:&quot;8f70a70a2e3f49528aa04ad35208b3fb&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:48.956242Z&quot;,&quot;message&quot;:&quot;Starting task: A&quot;,&quot;log.level&quot;:&quot;Debug&quot;,&quot;trace.id&quot;:&quot;cf727f370192c2bb156dd18a409c9dcc&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:49.011484Z&quot;,&quot;message&quot;:&quot;Finished first stage: A&quot;,&quot;log.level&quot;:&quot;Debug&quot;,&quot;trace.id&quot;:&quot;cf727f370192c2bb156dd18a409c9dcc&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:49.071507Z&quot;,&quot;message&quot;:&quot;Finished first stage: C&quot;,&quot;log.level&quot;:&quot;Debug&quot;,&quot;trace.id&quot;:&quot;ddbf3a089800458b85dea9b9f7d8d0e1&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:49.251522Z&quot;,&quot;message&quot;:&quot;Finished second stage: A&quot;,&quot;log.level&quot;:&quot;Debug&quot;,&quot;trace.id&quot;:&quot;cf727f370192c2bb156dd18a409c9dcc&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:49.874472Z&quot;,&quot;message&quot;:&quot;Finished task: A&quot;,&quot;log.level&quot;:&quot;Info&quot;,&quot;trace.id&quot;:&quot;cf727f370192c2bb156dd18a409c9dcc&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:49.964335Z&quot;,&quot;message&quot;:&quot;Finished second stage: C&quot;,&quot;log.level&quot;:&quot;Debug&quot;,&quot;trace.id&quot;:&quot;ddbf3a089800458b85dea9b9f7d8d0e1&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:49.976580Z&quot;,&quot;message&quot;:&quot;Finished second stage: B&quot;,&quot;log.level&quot;:&quot;Debug&quot;,&quot;trace.id&quot;:&quot;8f70a70a2e3f49528aa04ad35208b3fb&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:50.572548Z&quot;,&quot;message&quot;:&quot;Finished task: C&quot;,&quot;log.level&quot;:&quot;Info&quot;,&quot;trace.id&quot;:&quot;ddbf3a089800458b85dea9b9f7d8d0e1&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:50.717368Z&quot;,&quot;message&quot;:&quot;Finished task: B&quot;,&quot;log.level&quot;:&quot;Info&quot;,&quot;trace.id&quot;:&quot;8f70a70a2e3f49528aa04ad35208b3fb&quot;}
{&quot;@timestamp&quot;:&quot;2022-09-02 19:12:50.717448Z&quot;,&quot;message&quot;:&quot;Finished all tasks&quot;,&quot;log.level&quot;:&quot;Info&quot;,&quot;trace.id&quot;:&quot;a8be55ee47252520baa1dcae035d8170&quot;}
</span></code></pre>
<p>We added the identifier to the log message to make it easy to confirm that each unique transaction has a unique random trace id automatically attached to the log message. This shows that the actual function that performs the logging didn't need any modification. As long as we have access to the Logger instance, we can use the <code>log_transform</code> implementation and get easy context propagation for log tags for free!!</p>
<h2 id="conclusion">Conclusion</h2>
<p>Voila! we now have a way to generate machine-readable log messages and a lightweight method for automatic context propagation for independent async transactions.</p>
<p>This is all I have for now! If you like this post or have feedback do let me know, either via <a href="mailto:anurag@sonianurag.com">email</a> or on <a href="https://github.com/anuragsoni/anuragsoni.github.io/discussions">github</a>.</p>
<p>All the code in this post can be found <a href="https://github.com/anuragsoni/anuragsoni.github.io/blob/77227dedd4cd8617938b01b054496b75ca6b92e4/code/bin/log_example.ml">here</a>. If you notice any issues let me know via <a href="https://github.com/anuragsoni/anuragsoni.github.io/issues">github</a>.</p>


    </div>
</body>
</html>
